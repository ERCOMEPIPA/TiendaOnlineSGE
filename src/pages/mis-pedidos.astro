---
export const prerender = false;

import PublicLayout from "../layouts/PublicLayout.astro";
import { getUserSession } from "../lib/auth";
import { supabase } from "../lib/supabase";

// Check authentication
const userSession = await getUserSession(Astro.cookies);

if (!userSession?.user) {
    return Astro.redirect("/login?redirect=/mis-pedidos");
}

// Fetch user's orders
const { data: orders, error } = await supabase
    .from("orders")
    .select(`
        *,
        order_items (
            id,
            product_name,
            product_price,
            quantity,
            size
        )
    `)
    .eq("user_id", userSession.user.id)
    .order("created_at", { ascending: false });

const formatPrice = (cents: number) => {
    return new Intl.NumberFormat("es-ES", {
        style: "currency",
        currency: "EUR",
    }).format(cents / 100);
};

const formatDate = (date: string) => {
    return new Date(date).toLocaleDateString("es-ES", {
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
    });
};

const getStatusBadge = (status: string) => {
    const styles: Record<string, { bg: string; text: string; label: string }> = {
        pending: { bg: "bg-yellow-100", text: "text-yellow-800", label: "Pendiente" },
        confirmed: { bg: "bg-blue-100", text: "text-blue-800", label: "Confirmado" },
        shipped: { bg: "bg-purple-100", text: "text-purple-800", label: "Enviado" },
        delivered: { bg: "bg-green-100", text: "text-green-800", label: "Entregado" },
        cancelled: { bg: "bg-red-100", text: "text-red-800", label: "Cancelado" },
    };
    return styles[status] || styles.pending;
};
---

<PublicLayout title="Mis Pedidos" description="Historial de tus compras">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-serif font-bold text-gray-900">Mis Pedidos</h1>
            <p class="mt-2 text-gray-600">
                Historial de todas tus compras en FashionStore
            </p>
        </div>

        {error && (
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <p class="text-red-800">Error al cargar los pedidos</p>
            </div>
        )}

        {orders && orders.length === 0 && (
            <div class="bg-white rounded-xl shadow-sm p-12 text-center">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                <h3 class="text-xl font-medium text-gray-900 mb-2">No tienes pedidos aún</h3>
                <p class="text-gray-500 mb-6">¡Explora nuestra colección y haz tu primera compra!</p>
                <a 
                    href="/productos" 
                    class="inline-flex items-center px-6 py-3 bg-gray-900 text-white rounded-lg font-medium hover:bg-gray-800 transition-colors"
                >
                    Ver productos
                </a>
            </div>
        )}

        {orders && orders.length > 0 && (
            <div class="space-y-6">
                {orders.map((order: any) => {
                    const status = getStatusBadge(order.status);
                    return (
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <!-- Order Header -->
                            <div class="px-6 py-4 bg-gray-50 border-b border-gray-100 flex flex-wrap items-center justify-between gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">Pedido</p>
                                    <p class="font-mono font-semibold text-gray-900">
                                        #{order.id.slice(0, 8).toUpperCase()}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Fecha</p>
                                    <p class="font-medium text-gray-900">{formatDate(order.created_at)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Total</p>
                                    <p class="font-semibold text-gray-900">{formatPrice(order.total)}</p>
                                </div>
                                <div>
                                    <span class={`inline-flex px-3 py-1 rounded-full text-sm font-medium ${status.bg} ${status.text}`}>
                                        {status.label}
                                    </span>
                                </div>
                            </div>

                            <!-- Order Items -->
                            <div class="px-6 py-4">
                                <div class="space-y-3">
                                    {order.order_items?.map((item: any) => (
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                                            <div class="flex-1">
                                                <p class="font-medium text-gray-900">{item.product_name}</p>
                                                <p class="text-sm text-gray-500">
                                                    Talla: {item.size} · Cantidad: {item.quantity}
                                                </p>
                                            </div>
                                            <p class="font-medium text-gray-900">
                                                {formatPrice(item.product_price * item.quantity)}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <!-- Order Footer -->
                            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-500">
                                        Enviado a: {order.customer_name} ({order.customer_email})
                                    </div>
                                    {order.discount_amount > 0 && (
                                        <div class="text-sm text-green-600 font-medium">
                                            Descuento aplicado: -{formatPrice(order.discount_amount)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        )}
    </div>
</PublicLayout>
