---
export const prerender = false;

import PublicLayout from "../layouts/PublicLayout.astro";
import ProductCard from "../components/product/ProductCard.astro";
---

<PublicLayout
    title="Mis Favoritos"
    description="Tu lista de productos favoritos en FashionStore"
>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header -->
        <div class="mb-8">
            <h1
                class="text-3xl lg:text-4xl font-serif font-bold text-[#2a2622]"
            >
                Mis Favoritos
            </h1>
            <p class="mt-2 text-[#6f6458]">
                Productos que has guardado para más tarde
            </p>
        </div>

        <!-- Empty State (shown by default, hidden when there are items) -->
        <div id="empty-state" class="text-center py-16">
            <div class="max-w-md mx-auto">
                <svg
                    class="mx-auto h-24 w-24 text-carbon-300"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="1.5"
                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                    ></path>
                </svg>
                <h2 class="mt-4 text-xl font-semibold text-[#2a2622]">
                    Tu lista de favoritos está vacía
                </h2>
                <p class="mt-2 text-[#6f6458]">
                    Explora nuestra tienda y guarda los productos que te gusten
                    haciendo clic en el ícono de corazón.
                </p>
                <a
                    href="/productos"
                    class="mt-6 inline-flex items-center gap-2 bg-[#2a2622] text-white px-6 py-3 rounded-none
                           hover:bg-[#3d3831] transition-colors font-medium"
                    style="color: white !important;"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                        ></path>
                    </svg>
                    Explorar productos
                </a>
            </div>
        </div>

        <!-- Wishlist Items Grid (populated by JavaScript) -->
        <div id="wishlist-grid" class="hidden">
            <!-- Header with count -->
            <div class="flex items-center justify-between mb-6">
                <p class="text-[#6f6458]">
                    <span id="wishlist-count">0</span> producto(s) en tu lista
                </p>
                <button
                    id="clear-wishlist-btn"
                    class="text-sm text-red-600 hover:text-red-700 transition-colors flex items-center gap-1"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                        ></path>
                    </svg>
                    Limpiar lista
                </button>
            </div>

            <!-- Products Grid -->
            <div
                id="products-container"
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
            >
                <!-- Products will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div
            id="modal-backdrop"
            class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
        >
        </div>

        <!-- Modal Content -->
        <div class="flex items-center justify-center min-h-screen p-4">
            <div
                id="modal-content"
                class="relative bg-white rounded-none shadow-2xl max-w-md w-full p-6 transform transition-all border border-[#ccc5b8]"
            >
                <!-- Icon -->
                <div
                    class="mx-auto w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-4"
                >
                    <svg
                        class="w-8 h-8 text-red-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                        ></path>
                    </svg>
                </div>

                <!-- Text -->
                <h3 class="text-xl font-bold text-[#2a2622] text-center mb-2">
                    ¿Vaciar lista de favoritos?
                </h3>
                <p class="text-[#6f6458] text-center mb-6">
                    Se eliminarán todos los productos de tu lista de favoritos.
                    Esta acción no se puede deshacer.
                </p>

                <!-- Buttons -->
                <div class="flex gap-3">
                    <button
                        id="modal-cancel"
                        class="flex-1 px-4 py-3 border border-[#ccc5b8] rounded-none text-[#6f6458] font-medium hover:bg-[#fdfcf9] transition-colors"
                    >
                        Cancelar
                    </button>
                    <button
                        id="modal-confirm"
                        class="flex-1 px-4 py-3 bg-[#8B4513] text-[#fdfcf9] rounded-none font-medium hover:bg-[#a0522d] transition-colors flex items-center justify-center gap-2"
                    >
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                            ></path>
                        </svg>
                        Sí, vaciar
                    </button>
                </div>
            </div>
        </div>
    </div>
</PublicLayout>

<script>
    import {
        $wishlistItemsArray,
        loadWishlist,
        clearWishlist,
        removeFromWishlist,
    } from "../stores/wishlist";
    import { formatPrice } from "../lib/supabase";

    // Load wishlist on page load
    loadWishlist();

    // DOM elements
    const emptyState = document.getElementById("empty-state");
    const wishlistGrid = document.getElementById("wishlist-grid");
    const productsContainer = document.getElementById("products-container");
    const wishlistCount = document.getElementById("wishlist-count");
    const clearBtn = document.getElementById("clear-wishlist-btn");

    // Modal elements
    const modal = document.getElementById("confirm-modal");
    const modalBackdrop = document.getElementById("modal-backdrop");
    const modalCancel = document.getElementById("modal-cancel");
    const modalConfirm = document.getElementById("modal-confirm");

    // Show modal
    function showModal() {
        modal?.classList.remove("hidden");
        document.body.style.overflow = "hidden";
    }

    // Hide modal
    function hideModal() {
        modal?.classList.add("hidden");
        document.body.style.overflow = "";
    }

    // Clear wishlist button - show modal instead of confirm()
    clearBtn?.addEventListener("click", showModal);

    // Modal cancel button
    modalCancel?.addEventListener("click", hideModal);

    // Modal backdrop click
    modalBackdrop?.addEventListener("click", hideModal);

    // Modal confirm button
    modalConfirm?.addEventListener("click", () => {
        clearWishlist();
        hideModal();
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !modal?.classList.contains("hidden")) {
            hideModal();
        }
    });

    // Render function
    function renderWishlist() {
        const items = $wishlistItemsArray.get();

        if (items.length === 0) {
            emptyState?.classList.remove("hidden");
            wishlistGrid?.classList.add("hidden");
            return;
        }

        emptyState?.classList.add("hidden");
        wishlistGrid?.classList.remove("hidden");

        if (wishlistCount) {
            wishlistCount.textContent = items.length.toString();
        }

        if (productsContainer) {
            productsContainer.innerHTML = items
                .map(
                    ({ product, addedAt }) => `
                <div class="group bg-white rounded-none overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 border border-[#ccc5b8]">
                    <a href="/productos/${product.slug}" class="block">
                        <div class="aspect-[3/4] bg-[#fdfcf9] relative overflow-hidden">
                            ${
                                product.images?.[0]
                                    ? `<img src="${product.images[0]}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy">`
                                    : `<div class="w-full h-full flex items-center justify-center text-[#ccc5b8]">
                                    <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>`
                            }
                            ${product.featured ? `<span class="absolute top-3 left-3 bg-[#A68A4B] text-[#fdfcf9] text-xs font-bold px-2 py-1 rounded-none uppercase tracking-wider">Destacado</span>` : ""}
                            ${product.stock < 1 ? `<div class="absolute inset-0 bg-[#2a2622]/60 flex items-center justify-center"><span class="bg-[#fdfcf9] text-[#2a2622] px-4 py-2 rounded-none font-semibold">Agotado</span></div>` : ""}
                        </div>
                    </a>
                    
                    <div class="p-4">
                        ${product.artist ? `<p class="text-xs text-[#8B4513] font-semibold uppercase tracking-wider mb-1">${product.artist}</p>` : ""}
                        <a href="/productos/${product.slug}">
                            <h3 class="font-medium text-[#2a2622] hover:text-[#8B4513] transition-colors line-clamp-2">${product.name}</h3>
                        </a>
                        <p class="mt-2 text-lg font-serif font-semibold text-[#2a2622]">${formatPrice(product.price)}</p>
                        
                        <div class="mt-3 flex items-center justify-between">
                            <span class="text-xs text-[#6f6458]">
                                Añadido el ${new Date(addedAt).toLocaleDateString("es-ES")}
                            </span>
                            <button 
                                data-remove-id="${product.id}"
                                class="text-[#8B4513] hover:text-[#2a2622] transition-colors p-1"
                                title="Quitar de favoritos"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `,
                )
                .join("");

            // Add click handlers for remove buttons
            productsContainer
                .querySelectorAll("[data-remove-id]")
                .forEach((btn) => {
                    btn.addEventListener("click", (e) => {
                        e.preventDefault();
                        const productId = (btn as HTMLElement).dataset.removeId;
                        if (productId) {
                            removeFromWishlist(productId);
                        }
                    });
                });
        }
    }

    // Initial render
    renderWishlist();

    // Subscribe to changes
    $wishlistItemsArray.subscribe(() => {
        renderWishlist();
    });
</script>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Modal animation */
    #confirm-modal {
        animation: fadeIn 0.2s ease-out;
    }

    #modal-content {
        animation: slideUp 0.3s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
</style>
