---
export const prerender = false; // SSR page

import PublicLayout from "../layouts/PublicLayout.astro";
import CheckoutTimer from "../components/islands/CheckoutTimer";
---

<PublicLayout title="Carrito" description="Tu carrito de compras">
  <!-- Checkout Timer - Shows when reservation is active -->
  <CheckoutTimer client:load />

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl lg:text-4xl font-serif font-bold text-[#2a2622] mb-8">
      Tu Carrito
    </h1>

    <!-- Main grid layout -->
    <div id="cart-page-wrapper" class="lg:grid lg:grid-cols-3 lg:gap-8">
      <!-- Left column: cart items (dynamically rendered) -->
      <div class="lg:col-span-2">
        <div id="cart-page-content">
          <div
            class="bg-white rounded-none shadow-sm p-8 text-center border border-[#ccc5b8]"
          >
            <p class="text-[#6f6458]">Cargando carrito...</p>
          </div>
        </div>
      </div>

      <!-- Right column: Summary (static HTML, never re-rendered) -->
      <div class="mt-8 lg:mt-0" id="cart-summary-column">
        <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
          <h2 class="font-semibold text-lg text-carbon-900 mb-4">Resumen</h2>

          <!-- Coupon Section -->
          <div class="mb-4 pb-4 border-b border-carbon-100">
            <div id="coupon-container">
              <label class="block text-sm font-medium text-carbon-700 mb-2">
                ¿Tienes un cupón?
              </label>
              <div class="flex gap-2">
                <input
                  type="text"
                  id="coupon-input"
                  placeholder="Código de cupón"
                  class="flex-1 px-3 py-2 border border-carbon-200 rounded-lg text-sm uppercase focus:ring-2 focus:ring-navy-500 focus:border-transparent"
                />
                <button
                  id="apply-coupon-btn"
                  class="px-4 py-2 bg-carbon-800 text-white text-sm rounded-lg font-medium hover:bg-carbon-700 transition-colors"
                >
                  Aplicar
                </button>
              </div>
              <p id="coupon-message" class="text-sm mt-2 hidden"></p>
            </div>
            <div id="coupon-applied" class="hidden">
              <div
                class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200"
              >
                <div class="flex items-center gap-2">
                  <svg
                    class="w-5 h-5 text-green-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div>
                    <p
                      id="coupon-code-display"
                      class="font-medium text-green-800"
                    >
                    </p>
                    <p id="coupon-desc-display" class="text-sm text-green-600">
                    </p>
                  </div>
                </div>
                <button
                  id="remove-coupon-btn"
                  class="text-green-600 hover:text-green-800"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Inline Shipping Address Section -->
          <div class="mb-4 pb-4 border-b border-carbon-100">
            <h3
              class="text-sm font-semibold text-[#2a2622] mb-3 flex items-center gap-2"
            >
              <svg
                class="w-4 h-4 text-[#6f6458]"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              Dirección de Envío
            </h3>

            <!-- Guest info fields (only shown for non-logged-in users) -->
            <div id="guest-info-inline" class="space-y-3 mb-3 hidden">
              <div>
                <label class="block text-xs font-medium text-[#6f6458] mb-1"
                  >Nombre Completo *</label
                >
                <input
                  type="text"
                  id="inline-guest-name"
                  class="w-full px-3 py-2 border border-[#ccc5b8] rounded-lg text-sm focus:ring-2 focus:ring-[#8B4513] focus:border-transparent"
                  placeholder="Juan Pérez"
                />
              </div>
              <div>
                <label class="block text-xs font-medium text-[#6f6458] mb-1"
                  >Email *</label
                >
                <input
                  type="email"
                  id="inline-guest-email"
                  class="w-full px-3 py-2 border border-[#ccc5b8] rounded-lg text-sm focus:ring-2 focus:ring-[#8B4513] focus:border-transparent"
                  placeholder="juan@ejemplo.com"
                />
              </div>
              <div>
                <label class="block text-xs font-medium text-[#6f6458] mb-1"
                  >Teléfono *</label
                >
                <input
                  type="tel"
                  id="inline-guest-phone"
                  class="w-full px-3 py-2 border border-[#ccc5b8] rounded-lg text-sm focus:ring-2 focus:ring-[#8B4513] focus:border-transparent"
                  placeholder="+34 600 000 000"
                />
              </div>
              <div class="border-t border-[#ccc5b8] pt-3"></div>
            </div>

            <div class="space-y-3">
              <div>
                <label class="block text-xs font-medium text-[#6f6458] mb-1"
                  >Dirección *</label
                >
                <input
                  type="text"
                  id="inline-shipping-address"
                  class="w-full px-3 py-2 border border-[#ccc5b8] rounded-lg text-sm focus:ring-2 focus:ring-[#8B4513] focus:border-transparent"
                  placeholder="Calle Mayor, 123"
                />
              </div>
              <div>
                <label class="block text-xs font-medium text-[#6f6458] mb-1"
                  >Piso / Puerta (opcional)</label
                >
                <input
                  type="text"
                  id="inline-shipping-address2"
                  class="w-full px-3 py-2 border border-[#ccc5b8] rounded-lg text-sm focus:ring-2 focus:ring-[#8B4513] focus:border-transparent"
                  placeholder="2º B"
                />
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs font-medium text-[#6f6458] mb-1"
                    >Código Postal *</label
                  >
                  <input
                    type="text"
                    id="inline-shipping-postal"
                    class="w-full px-3 py-2 border border-[#ccc5b8] rounded-lg text-sm focus:ring-2 focus:ring-[#8B4513] focus:border-transparent"
                    placeholder="28001"
                  />
                </div>
                <div>
                  <label class="block text-xs font-medium text-[#6f6458] mb-1"
                    >Ciudad *</label
                  >
                  <input
                    type="text"
                    id="inline-shipping-city"
                    class="w-full px-3 py-2 border border-[#ccc5b8] rounded-lg text-sm focus:ring-2 focus:ring-[#8B4513] focus:border-transparent"
                    placeholder="Madrid"
                  />
                </div>
              </div>
              <div>
                <label class="block text-xs font-medium text-[#6f6458] mb-1"
                  >Provincia *</label
                >
                <input
                  type="text"
                  id="inline-shipping-province"
                  class="w-full px-3 py-2 border border-[#ccc5b8] rounded-lg text-sm focus:ring-2 focus:ring-[#8B4513] focus:border-transparent"
                  placeholder="Madrid"
                />
              </div>
            </div>
            <p id="shipping-error" class="text-xs text-red-600 mt-2 hidden"></p>
          </div>

          <!-- Totals -->
          <div class="space-y-3 text-sm">
            <div class="flex justify-between text-carbon-600">
              <span>Subtotal</span>
              <span id="cart-subtotal">0,00 €</span>
            </div>
            <div
              id="discount-row"
              class="flex justify-between text-green-600 hidden"
            >
              <span>Descuento</span>
              <span id="discount-amount">-0,00 €</span>
            </div>
            <div class="flex justify-between text-carbon-600">
              <span>Envío</span>
              <span id="cart-shipping">0,00 €</span>
            </div>
          </div>

          <div class="border-t border-carbon-100 mt-4 pt-4">
            <div class="flex justify-between font-semibold text-lg">
              <span>Total</span>
              <span id="final-total" class="text-navy-900">0,00 €</span>
            </div>
          </div>

          <button
            id="checkout-btn"
            class="w-full mt-6 py-3 px-6 bg-[#2a2622] text-[#fdfcf9] font-semibold rounded-none hover:bg-[#3d3831] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Proceder al pago
          </button>

          <p class="text-xs text-carbon-400 text-center mt-4">
            Envío gratis en pedidos superiores a 50€
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Reservation Expired Modal -->
  <div id="reservation-expired-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
        <div
          class="mx-auto w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center mb-4"
        >
          <svg
            class="w-8 h-8 text-yellow-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 text-center mb-2">
          ¡Tiempo de reserva agotado!
        </h3>
        <p class="text-gray-500 text-center mb-6">
          Tu reserva de 15 minutos ha expirado. Por favor, vuelve a iniciar el
          proceso de compra.
        </p>
        <button
          id="restart-checkout-btn"
          class="w-full px-4 py-3 bg-[#2a2622] text-[#fdfcf9] rounded-none font-medium hover:bg-[#3d3831] transition-colors"
        >
          Volver al carrito
        </button>
      </div>
    </div>
  </div>

  <!-- Stock Alert Modal -->
  <div id="stock-alert-modal" class="fixed inset-0 z-50 hidden">
    <div
      class="absolute inset-0 bg-black/60 backdrop-blur-sm"
      id="stock-alert-backdrop"
    >
    </div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div
        class="relative bg-[#1a2332] text-white rounded-xl shadow-2xl max-w-md w-full p-6 border border-gray-700"
      >
        <!-- Icon -->
        <div class="flex justify-center mb-6">
          <div
            class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center"
          >
            <svg
              class="w-8 h-8 text-red-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>
        </div>

        <div class="text-center">
          <h3 class="text-xl font-bold mb-2 font-serif tracking-wide">
            Stock Insuficiente
          </h3>
          <p class="text-gray-300 mb-6 leading-relaxed">
            Lo sentimos, no hay suficiente stock disponible de <span
              id="stock-alert-product-name"
              class="text-white font-semibold"></span>.
            <br /><br />
            <span
              class="text-sm bg-gray-800 px-3 py-1 rounded-full border border-gray-600"
            >
              Solo quedan <span
                id="stock-alert-count"
                class="text-red-400 font-bold"></span> unidades
            </span>
          </p>
          <button
            id="stock-alert-close-btn"
            class="w-full py-3 px-6 bg-white text-[#1a2332] font-bold rounded-lg hover:bg-gray-200 transition-colors"
          >
            Entendido
          </button>
        </div>
      </div>
    </div>
  </div>
</PublicLayout>

<script>
  import {
    $cartItemsArray,
    $cartTotal,
    removeItem,
    updateQuantity,
    clearCart,
    loadCart,
  } from "../stores/cart";
  import { formatPrice } from "../lib/supabase";
  import {
    startReservation,
    getReservation,
    clearReservation,
    getRemainingTime,
  } from "../lib/cartReservation";

  // Load cart on page load
  loadCart();

  // Coupon state
  let appliedCoupon: any = null;
  let currentDiscount = 0;
  let cartTotalValue = 0;

  // Auth state
  let isUserLoggedIn = false;

  // Handle reservation expiry modal
  const expiredModal = document.getElementById("reservation-expired-modal");
  const restartBtn = document.getElementById("restart-checkout-btn");

  restartBtn?.addEventListener("click", () => {
    expiredModal?.classList.add("hidden");
    clearReservation();
    window.location.reload();
  });

  // Handle stock alert modal
  const stockAlertModal = document.getElementById("stock-alert-modal");
  const stockAlertCloseBtn = document.getElementById("stock-alert-close-btn");
  const stockAlertBackdrop = document.getElementById("stock-alert-backdrop");

  function showStockAlert(productName: string, stock: number) {
    const nameEl = document.getElementById("stock-alert-product-name");
    const countEl = document.getElementById("stock-alert-count");

    if (nameEl) nameEl.textContent = `"${productName}"`;
    if (countEl) countEl.textContent = stock.toString();

    stockAlertModal?.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function hideStockAlert() {
    stockAlertModal?.classList.add("hidden");
    document.body.style.overflow = "";
  }

  stockAlertCloseBtn?.addEventListener("click", hideStockAlert);
  stockAlertBackdrop?.addEventListener("click", hideStockAlert);

  // Check for expired reservation on load
  const existingReservation = getReservation();
  if (existingReservation && getRemainingTime() <= 0) {
    clearReservation();
    expiredModal?.classList.remove("hidden");
  }

  // Listen for custom expiry event from CheckoutTimer
  window.addEventListener("reservationExpired", () => {
    expiredModal?.classList.remove("hidden");
  });

  // Check auth state on load and show/hide guest fields
  (async () => {
    try {
      const sessionResp = await fetch("/api/auth/session");
      const sessionData = await sessionResp.json();
      isUserLoggedIn = !!sessionData.user;
    } catch (e) {
      isUserLoggedIn = false;
    }

    const guestInfoSection = document.getElementById("guest-info-inline");
    if (!isUserLoggedIn && guestInfoSection) {
      guestInfoSection.classList.remove("hidden");
    }
  })();

  // Helper to update totals in the static summary panel
  function updateTotals(total: number) {
    const subtotalEl = document.getElementById("cart-subtotal");
    const shippingEl = document.getElementById("cart-shipping");
    const finalTotalEl = document.getElementById("final-total");

    const shipping = total >= 5000 ? 0 : 495;

    if (subtotalEl) subtotalEl.textContent = formatPrice(total);
    if (shippingEl)
      shippingEl.textContent = total >= 5000 ? "Gratis" : formatPrice(495);

    const finalTotal = total - currentDiscount + shipping;
    if (finalTotalEl) finalTotalEl.textContent = formatPrice(finalTotal);

    // Also show/hide the summary column based on cart state
    const summaryCol = document.getElementById("cart-summary-column");
    const items = $cartItemsArray.get();
    if (summaryCol) {
      summaryCol.style.display = items.length === 0 ? "none" : "";
    }
  }

  function renderCart() {
    const container = document.getElementById("cart-page-content");
    if (!container) return;

    const items = $cartItemsArray.get();
    const total = $cartTotal.get();
    cartTotalValue = total;

    if (items.length === 0) {
      container.innerHTML = `
        <div class="bg-white rounded-xl shadow-sm p-12 text-center">
          <svg class="w-20 h-20 mx-auto text-[#ccc5b8] mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                  d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          <h2 class="text-xl font-semibold text-[#2a2622] mb-2">Tu carrito está vacío</h2>
          <p class="text-[#6f6458] mb-6">¡Explora nuestra tienda y encuentra productos increíbles!</p>
          <a href="/productos" class="inline-flex items-center gap-2 px-6 py-3 bg-[#2a2622] font-semibold rounded-none hover:bg-[#3d3831] transition-colors" style="color: #ffffff;">
            Ver productos
          </a>
        </div>
      `;
      updateTotals(0);
      return;
    }

    const itemsHtml = items
      .map((item) => {
        const colorDisplay = item.color ? item.color.split(":")[0] : "";
        const now = new Date();
        const discountPriceInCents = item.product.discount_price
          ? item.product.discount_price * 100
          : null;
        const hasDiscount =
          discountPriceInCents &&
          discountPriceInCents < item.product.price &&
          (!item.product.discount_end_date ||
            new Date(item.product.discount_end_date) > now);
        const displayPrice = hasDiscount
          ? discountPriceInCents
          : item.product.price;
        const itemTotal = displayPrice * item.quantity;

        return `
      <div class="flex gap-4 p-4 border-b border-carbon-100" data-item-key="${item.product.id}-${item.size}-${item.color}">
        <div class="w-24 h-24 bg-carbon-100 rounded-lg overflow-hidden flex-shrink-0">
          ${
            item.product.images?.[0]
              ? `<img src="${item.product.images[0]}" alt="${item.product.name}" class="w-full h-full object-cover" />`
              : `<div class="w-full h-full flex items-center justify-center text-carbon-400">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>`
          }
        </div>
        <div class="flex-1">
          <h3 class="font-medium text-[#2a2622]">${item.product.name}</h3>
          <p class="text-sm text-[#6f6458]">Talla: ${item.size}${colorDisplay ? ` | Color: ${colorDisplay}` : ""}</p>
          ${
            hasDiscount
              ? `<div class="flex items-center gap-2 mt-1">
                <p class="font-semibold text-red-600">${formatPrice(displayPrice)}</p>
                <p class="text-sm text-[#6f6458] line-through">${formatPrice(item.product.price)}</p>
              </div>`
              : `<p class="font-semibold text-[#8B4513] mt-1">${formatPrice(item.product.price)}</p>`
          }
          
          <div class="flex items-center gap-4 mt-3">
            <div class="flex items-center gap-2">
              <button 
                class="qty-btn w-8 h-8 rounded border border-carbon-200 flex items-center justify-center text-carbon-600 hover:border-navy-400"
                data-action="decrease"
                data-product-id="${item.product.id}"
                data-size="${item.size}"
                data-color="${item.color || ""}"
                data-qty="${item.quantity}"
              >−</button>
              <span class="w-10 text-center font-medium">${item.quantity}</span>
              <button 
                class="qty-btn w-8 h-8 rounded border border-carbon-200 flex items-center justify-center text-carbon-600 hover:border-navy-400"
                data-action="increase"
                data-product-id="${item.product.id}"
                data-size="${item.size}"
                data-color="${item.color || ""}"
                data-qty="${item.quantity}"
              >+</button>
            </div>
            <button 
              class="remove-btn text-carbon-400 hover:text-red-500 transition-colors"
              data-product-id="${item.product.id}"
              data-size="${item.size}"
              data-color="${item.color || ""}"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>
        <div class="text-right">
          <p class="font-semibold text-carbon-900">${formatPrice(itemTotal)}</p>
        </div>
      </div>
    `;
      })
      .join("");

    container.innerHTML = `
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        ${itemsHtml}
      </div>
      <button id="clear-cart" class="mt-4 text-sm text-[#6f6458] hover:text-[#8B4513] transition-colors">
        Vaciar carrito
      </button>
    `;

    // Update totals in static summary panel
    updateTotals(total);

    // Add event listeners for qty and remove buttons
    document.querySelectorAll(".qty-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const target = e.currentTarget as HTMLElement;
        const action = target.dataset.action;
        const productId = target.dataset.productId!;
        const size = target.dataset.size!;
        const color = target.dataset.color || "";
        const qty = parseInt(target.dataset.qty!);

        if (action === "decrease") {
          updateQuantity(productId, size, color, qty - 1);
        } else {
          // Check stock before increasing
          const currentItems = $cartItemsArray.get();
          const item = currentItems.find(
            (i) =>
              i.product.id === productId &&
              i.size === size &&
              (i.color || "") === color,
          );

          if (item && qty + 1 > item.product.stock) {
            showStockAlert(item.product.name, item.product.stock);
            return;
          }
          updateQuantity(productId, size, color, qty + 1);
        }
        renderCart();
      });
    });

    document.querySelectorAll(".remove-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const target = e.currentTarget as HTMLElement;
        const productId = target.dataset.productId!;
        const size = target.dataset.size!;
        const color = target.dataset.color || "";
        removeItem(productId, size, color);
        renderCart();
      });
    });

    document.getElementById("clear-cart")?.addEventListener("click", () => {
      clearCart();
      renderCart();
    });
  }

  // processCheckout function (outside renderCart)
  async function processCheckout(
    guestInfo: any = null,
    shippingInfo: any = null,
  ) {
    const checkoutBtn = document.getElementById("checkout-btn");
    if (!checkoutBtn) return;
    const items = $cartItemsArray.get();

    checkoutBtn.textContent = "Procesando...";
    checkoutBtn.setAttribute("disabled", "true");

    // Start cart reservation timer
    startReservation(items);

    // Dispatch event to show timer
    window.dispatchEvent(new CustomEvent("reservationStarted"));

    try {
      const response = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          items: items,
          couponCode: appliedCoupon?.code,
          discountAmount: currentDiscount,
          guestInfo: guestInfo,
          shippingInfo: shippingInfo,
        }),
      });

      const data = await response.json();

      if (data.error) {
        alert("Error: " + data.error);
        checkoutBtn.textContent = "Proceder al pago";
        checkoutBtn.removeAttribute("disabled");
        clearReservation();
        return;
      }

      // Redirect to Stripe Checkout
      if (data.url) {
        window.location.href = data.url;
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error al procesar el pago. Por favor, intenta de nuevo.");
      checkoutBtn.textContent = "Proceder al pago";
      checkoutBtn.removeAttribute("disabled");
      clearReservation();
    }
  }

  // Initial render
  renderCart();

  // Re-render when cart changes
  $cartItemsArray.subscribe(() => {
    renderCart();
  });

  // Checkout button handler (event delegation, outside renderCart)
  document
    .getElementById("checkout-btn")
    ?.addEventListener("click", async () => {
      const shippingError = document.getElementById("shipping-error");

      // Collect inline shipping address fields
      const address = (
        document.getElementById("inline-shipping-address") as HTMLInputElement
      )?.value?.trim();
      const address2 =
        (
          document.getElementById(
            "inline-shipping-address2",
          ) as HTMLInputElement
        )?.value?.trim() || "";
      const postalCode = (
        document.getElementById("inline-shipping-postal") as HTMLInputElement
      )?.value?.trim();
      const city = (
        document.getElementById("inline-shipping-city") as HTMLInputElement
      )?.value?.trim();
      const province = (
        document.getElementById("inline-shipping-province") as HTMLInputElement
      )?.value?.trim();

      // Validate shipping address
      if (!address || !postalCode || !city || !province) {
        if (shippingError) {
          shippingError.textContent =
            "Por favor, completa todos los campos obligatorios de la dirección de envío.";
          shippingError.classList.remove("hidden");
        }
        return;
      }

      // Hide error if shown
      if (shippingError) shippingError.classList.add("hidden");

      const shippingInfo = { address, address2, postalCode, city, province };

      if (!isUserLoggedIn) {
        // Collect guest info from inline fields
        const guestName = (
          document.getElementById("inline-guest-name") as HTMLInputElement
        )?.value?.trim();
        const guestEmail = (
          document.getElementById("inline-guest-email") as HTMLInputElement
        )?.value?.trim();
        const guestPhone = (
          document.getElementById("inline-guest-phone") as HTMLInputElement
        )?.value?.trim();

        if (!guestName || !guestEmail || !guestPhone) {
          if (shippingError) {
            shippingError.textContent =
              "Por favor, completa tu nombre, email y teléfono.";
            shippingError.classList.remove("hidden");
          }
          return;
        }

        const guestInfo = {
          name: guestName,
          email: guestEmail,
          phone: guestPhone,
          address: shippingInfo.address,
          address2: shippingInfo.address2,
          postalCode: shippingInfo.postalCode,
          city: shippingInfo.city,
          province: shippingInfo.province,
        };

        await processCheckout(guestInfo);
      } else {
        // Logged-in user: send shipping info
        await processCheckout(null, shippingInfo);
      }
    });

  // Global event delegation for coupon handlers
  document.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;

    // Apply coupon button
    if (
      target.id === "apply-coupon-btn" ||
      target.closest("#apply-coupon-btn")
    ) {
      const couponInput = document.getElementById(
        "coupon-input",
      ) as HTMLInputElement;
      const couponMessage = document.getElementById("coupon-message");

      if (!couponInput) return;

      const code = couponInput.value.trim().toUpperCase();

      if (!code) {
        if (couponMessage) {
          couponMessage.textContent = "Introduce un código";
          couponMessage.className = "text-sm mt-2 text-red-600";
          couponMessage.classList.remove("hidden");
        }
        return;
      }

      const btn = document.getElementById("apply-coupon-btn");
      if (btn) btn.textContent = "...";

      try {
        const response = await fetch("/api/validate-coupon", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code, cartTotal: cartTotalValue }),
        });

        const data = await response.json();

        if (data.valid) {
          appliedCoupon = data.coupon;
          currentDiscount = data.discountAmount;

          const couponContainer = document.getElementById("coupon-container");
          const couponApplied = document.getElementById("coupon-applied");
          const couponCodeDisplay = document.getElementById(
            "coupon-code-display",
          );
          const couponDescDisplay = document.getElementById(
            "coupon-desc-display",
          );
          const discountRow = document.getElementById("discount-row");
          const discountAmountEl = document.getElementById("discount-amount");
          const finalTotalEl = document.getElementById("final-total");

          if (couponContainer) couponContainer.classList.add("hidden");
          if (couponApplied) couponApplied.classList.remove("hidden");
          if (couponCodeDisplay)
            couponCodeDisplay.textContent = data.coupon.code;
          if (couponDescDisplay) couponDescDisplay.textContent = data.message;
          if (discountRow) discountRow.classList.remove("hidden");
          if (discountAmountEl)
            discountAmountEl.textContent = "-" + formatPrice(currentDiscount);

          const shipping = cartTotalValue >= 5000 ? 0 : 495;
          const newTotal = cartTotalValue - currentDiscount + shipping;
          if (finalTotalEl) finalTotalEl.textContent = formatPrice(newTotal);
        } else {
          if (couponMessage) {
            couponMessage.textContent = data.error || "Cupón no válido";
            couponMessage.className = "text-sm mt-2 text-red-600";
            couponMessage.classList.remove("hidden");
          }
        }
      } catch (error) {
        console.error("Coupon error:", error);
        if (couponMessage) {
          couponMessage.textContent = "Error al validar el cupón";
          couponMessage.className = "text-sm mt-2 text-red-600";
          couponMessage.classList.remove("hidden");
        }
      } finally {
        if (btn) btn.textContent = "Aplicar";
      }
    }

    // Remove coupon button
    if (
      target.id === "remove-coupon-btn" ||
      target.closest("#remove-coupon-btn")
    ) {
      appliedCoupon = null;
      currentDiscount = 0;

      const couponContainer = document.getElementById("coupon-container");
      const couponApplied = document.getElementById("coupon-applied");
      const couponInput = document.getElementById(
        "coupon-input",
      ) as HTMLInputElement;
      const discountRow = document.getElementById("discount-row");
      const finalTotalEl = document.getElementById("final-total");

      if (couponContainer) couponContainer.classList.remove("hidden");
      if (couponApplied) couponApplied.classList.add("hidden");
      if (couponInput) couponInput.value = "";
      if (discountRow) discountRow.classList.add("hidden");

      const shipping = cartTotalValue >= 5000 ? 0 : 495;
      if (finalTotalEl)
        finalTotalEl.textContent = formatPrice(cartTotalValue + shipping);
    }
  });
</script>
