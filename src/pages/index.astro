---
export const prerender = false;

import PublicLayout from "../layouts/PublicLayout.astro";
import ProductCard from "../components/product/ProductCard.astro";
import Button from "../components/ui/Button.astro";
import { supabase } from "../lib/supabase";
import type { Product, Category } from "../lib/supabase";

// Fetch featured products
const { data: featuredProducts } = await supabase
	.from("products")
	.select("*")
	.eq("featured", true)
	.limit(4);

// Fetch all categories
const { data: categories } = await supabase
	.from("categories")
	.select("*")
	.order("name");

// Fetch products for each category (for slideshow)
const { data: allProducts } = await supabase
	.from("products")
	.select("id, name, images, category_id")
	.not("images", "is", null)
	.limit(50);

// Mock data for demo (remove when Supabase is connected)
const mockProducts: Product[] = [
	{
		id: "1",
		name: "Camiseta Tour 2024 - Bad Bunny",
		slug: "camiseta-tour-2024-bad-bunny",
		description: "Camiseta oficial del World Tour 2024",
		price: 3500,
		discount_price: null,
		discount_end_date: null,
		stock: 15,
		sizes: ["S", "M", "L", "XL"],
		colors: ["Negro:#000000", "Blanco:#FFFFFF"],
		category_id: null,
		images: [
			"https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400",
		],
		featured: true,
		artist: "Bad Bunny",
		created_at: "",
		updated_at: "",
	},
	{
		id: "2",
		name: "Sudadera Midnight - Taylor Swift",
		slug: "sudadera-midnight-taylor-swift",
		description: "Sudadera Midnights Edition",
		price: 5900,
		discount_price: null,
		discount_end_date: null,
		stock: 8,
		sizes: ["S", "M", "L"],
		colors: ["Negro:#000000", "Gris:#6B7280"],
		category_id: null,
		images: [
			"https://images.unsplash.com/photo-1556821840-3a63f95609a7?w=400",
		],
		featured: true,
		artist: "Taylor Swift",
		created_at: "",
		updated_at: "",
	},
	{
		id: "3",
		name: "Gorra Logo - Drake",
		slug: "gorra-logo-drake",
		description: "Gorra bordada con logo OVO",
		price: 2900,
		discount_price: null,
		discount_end_date: null,
		stock: 25,
		sizes: ["Única"],
		colors: ["Negro:#000000"],
		category_id: null,
		images: [
			"https://images.unsplash.com/photo-1588850561407-ed78c282e89b?w=400",
		],
		featured: true,
		artist: "Drake",
		created_at: "",
		updated_at: "",
	},
	{
		id: "4",
		name: "Hoodie Astroworld - Travis Scott",
		slug: "hoodie-astroworld-travis-scott",
		description: "Hoodie edición limitada Astroworld",
		price: 7500,
		discount_price: null,
		discount_end_date: null,
		stock: 3,
		sizes: ["M", "L", "XL"],
		colors: ["Negro:#000000", "Naranja:#F97316"],
		category_id: null,
		images: [
			"https://images.unsplash.com/photo-1578768079052-aa76e52ff62e?w=400",
		],
		featured: true,
		artist: "Travis Scott",
		created_at: "",
		updated_at: "",
	},
];

const products = featuredProducts?.length ? featuredProducts : mockProducts;

const mockCategories: Category[] = [
	{ id: "1", name: "Camisetas", slug: "camisetas", created_at: "" },
	{ id: "2", name: "Sudaderas", slug: "sudaderas", created_at: "" },
	{ id: "3", name: "Accesorios", slug: "accesorios", created_at: "" },
];

const cats = categories?.length ? categories : mockCategories;

// Create a map of category images for slideshow
const categoryProductsMap: Record<string, string[]> = {};
cats.forEach((cat) => {
	// Get products for this category
	const catProducts =
		allProducts?.filter((p) => p.category_id === cat.id) || [];
	// Extract images (first image of each product)
	const images = catProducts
		.map((p) => p.images?.[0])
		.filter((img): img is string => !!img)
		.slice(0, 5); // Max 5 images per category
	categoryProductsMap[cat.slug] = images;
});
---

<PublicLayout
	title="Inicio"
	description="HYPESTAGE - Tu tienda de merch personalizado de tus artistas favoritos"
>
	<!-- Hero Section Origin Style -->
	<section
		class="relative bg-cream-100 text-navy-900 overflow-hidden min-h-[600px] md:min-h-[500px] lg:min-h-[600px]"
	>
		<!-- Background Carousel -->
		<div class="absolute inset-0">
			<div
				id="hero-product-carousel"
				class="flex transition-transform duration-1000 ease-in-out h-full"
				data-products={JSON.stringify(
					products.slice(0, 6).map((p) => ({
						artist: p.artist || "Exclusivo",
						name: p.name,
						price: p.price,
						discount_price: p.discount_price || null,
						discount_end_date: p.discount_end_date || null,
					})),
				)}
			>
				{
					products.slice(0, 6).map((product, index) => (
						<div class="min-w-full h-full relative flex-shrink-0">
							<img
								src={
									product.images?.[0] ||
									"https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=1200"
								}
								alt={product.name}
								class="w-full h-full object-cover"
							/>
						</div>
					))
				}
			</div>
			<!-- Overlay Origin style -->
			<div
				class="absolute inset-0 bg-gradient-to-r from-cream-100/80 via-cream-100/50 to-cream-100/20"
			>
			</div>
		</div>

		<!-- Content -->
		<div
			class="relative max-w-7xl mx-auto px-12 sm:px-16 lg:px-8 py-16 md:py-20 lg:py-32 z-10"
		>
			<div class="max-w-lg lg:max-w-xl">
				<h1
					class="text-3xl sm:text-4xl lg:text-6xl font-serif italic leading-tight animate-slide-up text-[#2a2622]"
				>
					Merch exclusivo de tus
					<span class="text-[#8B4513]">artistas favoritos</span>
				</h1>
				<p
					class="mt-4 sm:mt-6 text-base sm:text-lg text-[#5c544a] animate-slide-up"
					style="animation-delay: 0.1s;"
				>
					Colecciones oficiales, ediciones limitadas y productos
					únicos. Viste tu pasión por la música con estilo.
				</p>
				<div
					class="mt-6 sm:mt-8 flex flex-col sm:flex-row gap-3 sm:gap-4 animate-slide-up"
					style="animation-delay: 0.2s;"
				>
					<Button href="/productos" variant="primary" size="lg">
						Ver colección
					</Button>
					<Button href="#categorias" variant="outline" size="lg">
						Explorar
					</Button>
				</div>

				<!-- Current Product Info -->
				<div
					id="hero-product-info"
					class="mt-6 sm:mt-10 animate-slide-up"
					style="animation-delay: 0.3s;"
				>
					<div
						class="inline-flex flex-col sm:flex-row sm:items-center gap-1.5 sm:gap-3 bg-white/10 backdrop-blur-xl rounded-xl sm:rounded-full px-4 sm:px-5 py-3 sm:py-2.5 border border-white/20 shadow-glass"
					>
						<span
							class="text-[#8B4513] font-medium text-sm sm:text-base"
							id="hero-product-artist"
							>{products[0]?.artist || "Exclusivo"}</span
						>
						<span class="text-white/60 hidden sm:inline">|</span>
						<span
							class="text-[#8B4513] text-sm sm:text-base line-clamp-1"
							id="hero-product-name">{products[0]?.name}</span
						>
						<span class="text-white/60 hidden sm:inline">|</span>
						<span
							class="text-[#8B4513] font-semibold text-sm sm:text-base"
							id="hero-product-price"
						>
							{
								(() => {
									const product = products[0];
									if (!product) return "0,00 €";

									const now = new Date();
									const hasDiscount =
										product.discount_price &&
										product.discount_price * 100 <
											product.price &&
										(!product.discount_end_date ||
											new Date(
												product.discount_end_date,
											) > now);

									const formatCurrency = (cents: number) =>
										new Intl.NumberFormat("es-ES", {
											style: "currency",
											currency: "EUR",
										}).format(cents / 100);

									if (hasDiscount) {
										return formatCurrency(
											product.discount_price * 100,
										);
									}
									return formatCurrency(product.price);
								})()
							}
						</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Carousel Indicators -->
		<div
			class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-3 z-20"
		>
			{
				products
					.slice(0, 6)
					.map((_, index) => (
						<button
							class={`hero-carousel-dot w-3 h-3 rounded-full transition-all duration-300 ${index === 0 ? "bg-[#8B4513] scale-125" : "bg-white/40 hover:bg-white/70"}`}
							data-index={index}
						/>
					))
			}
		</div>

		<!-- Navigation Arrows -->
		<button
			id="hero-carousel-prev"
			class="absolute left-1 sm:left-2 lg:left-8 top-1/2 -translate-y-1/2 w-9 h-9 sm:w-10 sm:h-10 lg:w-12 lg:h-12 rounded-full bg-[#2a2622]/80 sm:bg-[#2a2622] flex items-center justify-center text-white hover:bg-[#3d3831] transition-all z-20 shadow-lg"
		>
			<svg
				class="w-4 h-4 sm:w-5 sm:h-5 lg:w-6 lg:h-6"
				fill="none"
				stroke="currentColor"
				viewBox="0 0 24 24"
			>
				<path
					stroke-linecap="round"
					stroke-linejoin="round"
					stroke-width="2"
					d="M15 19l-7-7 7-7"></path>
			</svg>
		</button>
		<button
			id="hero-carousel-next"
			class="absolute right-1 sm:right-2 lg:right-8 top-1/2 -translate-y-1/2 w-9 h-9 sm:w-10 sm:h-10 lg:w-12 lg:h-12 rounded-full bg-[#2a2622]/80 sm:bg-[#2a2622] flex items-center justify-center text-white hover:bg-[#3d3831] transition-all z-20 shadow-lg"
		>
			<svg
				class="w-4 h-4 sm:w-5 sm:h-5 lg:w-6 lg:h-6"
				fill="none"
				stroke="currentColor"
				viewBox="0 0 24 24"
			>
				<path
					stroke-linecap="round"
					stroke-linejoin="round"
					stroke-width="2"
					d="M9 5l7 7-7 7"></path>
			</svg>
		</button>
	</section>

	<!-- Featured Products -->
	<section class="py-16 lg:py-24">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex items-end justify-between mb-10">
				<div>
					<h2
						class="text-3xl lg:text-4xl font-serif font-bold text-carbon-900"
					>
						Productos Destacados
					</h2>
					<p class="mt-2 text-carbon-500">
						Lo más buscado de esta temporada
					</p>
				</div>
				<a
					href="/productos"
					class="hidden sm:flex items-center gap-2 text-navy-800 font-medium hover:text-[#8B4513] transition-colors"
				>
					Ver todo
					<svg
						class="w-4 h-4"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M9 5l7 7-7 7"></path>
					</svg>
				</a>
			</div>

			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
				{products.map((product) => <ProductCard product={product} />)}
			</div>

			<div class="mt-10 text-center sm:hidden">
				<Button href="/productos" variant="outline"
					>Ver todos los productos</Button
				>
			</div>
		</div>
	</section>

	<!-- Categories Origin Style -->
	<section id="categorias" class="py-16 lg:py-24 bg-cream-50">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="text-center mb-14">
				<h2
					class="text-3xl lg:text-5xl font-serif italic text-navy-900"
				>
					Compra por Categoría
				</h2>
				<p class="mt-3 text-carbon-500 text-lg">
					Encuentra exactamente lo que buscas
				</p>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-3 gap-8">
				{
					cats.map((category) => {
						const images = categoryProductsMap[category.slug] || [];
						return (
							<a
								href={`/categoria/${category.slug}`}
								class="group relative h-72 overflow-hidden bg-cream-100 border border-carbon-200 shadow-soft hover:shadow-medium transition-all duration-400"
								data-category-card
								data-images={JSON.stringify(images)}
							>
								{/* Slideshow container */}
								<div class="absolute inset-0 category-slideshow">
									{images.length > 0 ? (
										images.map((img, imgIndex) => (
											<img
												src={img}
												alt={category.name}
												class={`absolute inset-0 w-full h-full object-cover transition-opacity duration-700 ${imgIndex === 0 ? "opacity-100" : "opacity-0"}`}
												data-slide-index={imgIndex}
												loading="lazy"
											/>
										))
									) : (
										<div class="absolute inset-0 bg-navy-800" />
									)}
								</div>

								{/* Overlay Origin style - Dark brown */}
								<div class="absolute inset-0 bg-gradient-to-t from-[#2a2622]/90 via-[#2a2622]/50 to-[#2a2622]/20 z-10" />

								{/* Content */}
								<div class="absolute bottom-0 left-0 right-0 p-6 z-20">
									<h3 class="text-xl font-serif italic text-cream-50">
										{category.name}
									</h3>
									<span class="inline-flex items-center gap-2 mt-2 text-xs uppercase tracking-wider font-medium text-cream-100">
										Explorar colección
										<svg
											class="w-4 h-4 group-hover:translate-x-2 transition-transform duration-300"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M17 8l4 4m0 0l-4 4m4-4H3"
											/>
										</svg>
									</span>
								</div>
							</a>
						);
					})
				}
			</div>
		</div>
	</section>
</PublicLayout>

<script>
	// Category slideshow animation
	document.addEventListener("DOMContentLoaded", () => {
		const categoryCards = document.querySelectorAll("[data-category-card]");

		categoryCards.forEach((card) => {
			const images = card.querySelectorAll("[data-slide-index]");
			if (images.length <= 1) return; // No slideshow needed

			let currentIndex = 0;

			setInterval(() => {
				// Hide current
				images[currentIndex].classList.remove("opacity-100");
				images[currentIndex].classList.add("opacity-0");

				// Show next
				currentIndex = (currentIndex + 1) % images.length;
				images[currentIndex].classList.remove("opacity-0");
				images[currentIndex].classList.add("opacity-100");
			}, 3000);
		});

		// Hero Product Carousel
		const carousel = document.getElementById("hero-product-carousel");
		const prevBtn = document.getElementById("hero-carousel-prev");
		const nextBtn = document.getElementById("hero-carousel-next");
		const dots = document.querySelectorAll(".hero-carousel-dot");
		const productArtist = document.getElementById("hero-product-artist");
		const productName = document.getElementById("hero-product-name");
		const productPrice = document.getElementById("hero-product-price");

		if (carousel && dots.length > 0) {
			const slides = carousel.children;
			const totalSlides = slides.length;
			let currentSlide = 0;
			let autoPlayInterval: number;

			// Get products data from the carousel data attribute
			const productsData = JSON.parse(carousel.dataset.products || "[]");

			function formatPrice(cents: number): string {
				return new Intl.NumberFormat("es-ES", {
					style: "currency",
					currency: "EUR",
				}).format(cents / 100);
			}

			function updateProductInfo(index: number) {
				if (productsData[index]) {
					const product = productsData[index];
					if (productArtist)
						productArtist.textContent = product.artist;
					if (productName) productName.textContent = product.name;
					if (productPrice) {
						const now = new Date();
						const hasDiscount =
							product.discount_price &&
							product.discount_price * 100 < product.price &&
							(!product.discount_end_date ||
								new Date(product.discount_end_date) > now);

						if (hasDiscount) {
							productPrice.textContent = formatPrice(
								product.discount_price * 100,
							);
						} else {
							productPrice.textContent = formatPrice(
								product.price,
							);
						}
					}
				}
			}

			function goToSlide(index: number) {
				if (!carousel) return;
				if (index < 0) index = totalSlides - 1;
				if (index >= totalSlides) index = 0;

				currentSlide = index;
				carousel.style.transform = `translateX(-${currentSlide * 100}%)`;

				// Update dots
				dots.forEach((dot, i) => {
					if (i === currentSlide) {
						dot.classList.add("bg-[#8B4513]", "scale-125");
						dot.classList.remove("bg-white/40");
					} else {
						dot.classList.remove("bg-[#8B4513]", "scale-125");
						dot.classList.add("bg-white/40");
					}
				});

				// Update product info
				updateProductInfo(currentSlide);
			}

			function nextSlide() {
				goToSlide(currentSlide + 1);
			}

			function prevSlide() {
				goToSlide(currentSlide - 1);
			}

			function startAutoPlay() {
				autoPlayInterval = window.setInterval(nextSlide, 4000);
			}

			function stopAutoPlay() {
				clearInterval(autoPlayInterval);
			}

			// Event listeners
			prevBtn?.addEventListener("click", () => {
				prevSlide();
				stopAutoPlay();
				startAutoPlay();
			});

			nextBtn?.addEventListener("click", () => {
				nextSlide();
				stopAutoPlay();
				startAutoPlay();
			});

			dots.forEach((dot, index) => {
				dot.addEventListener("click", () => {
					goToSlide(index);
					stopAutoPlay();
					startAutoPlay();
				});
			});

			// Pause on hover
			carousel.addEventListener("mouseenter", stopAutoPlay);
			carousel.addEventListener("mouseleave", startAutoPlay);

			// Start auto-play
			startAutoPlay();
		}
	});
</script>
