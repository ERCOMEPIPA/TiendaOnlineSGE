---
export const prerender = false;

import PublicLayout from "../layouts/PublicLayout.astro";
import ProductCard from "../components/product/ProductCard.astro";
import Button from "../components/ui/Button.astro";
import { supabase } from "../lib/supabase";
import type { Product, Category } from "../lib/supabase";

// Fetch featured products
const { data: featuredProducts } = await supabase
	.from("products")
	.select("*")
	.eq("featured", true)
	.limit(4);

// Fetch all categories
const { data: categories } = await supabase
	.from("categories")
	.select("*")
	.order("name");

// Fetch products for each category (for slideshow)
const { data: allProducts } = await supabase
	.from("products")
	.select("id, name, images, category_id")
	.not("images", "is", null)
	.limit(50);

// Mock data for demo (remove when Supabase is connected)
const mockProducts: Product[] = [
	{
		id: "1",
		name: "Camiseta Tour 2024 - Bad Bunny",
		slug: "camiseta-tour-2024-bad-bunny",
		description: "Camiseta oficial del World Tour 2024",
		price: 3500,
		stock: 15,
		sizes: ["S", "M", "L", "XL"],
		colors: ["Negro:#000000", "Blanco:#FFFFFF"],
		category_id: null,
		images: [
			"https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400",
		],
		featured: true,
		artist: "Bad Bunny",
		created_at: "",
		updated_at: "",
	},
	{
		id: "2",
		name: "Sudadera Midnight - Taylor Swift",
		slug: "sudadera-midnight-taylor-swift",
		description: "Sudadera Midnights Edition",
		price: 5900,
		stock: 8,
		sizes: ["S", "M", "L"],
		colors: ["Negro:#000000", "Gris:#6B7280"],
		category_id: null,
		images: [
			"https://images.unsplash.com/photo-1556821840-3a63f95609a7?w=400",
		],
		featured: true,
		artist: "Taylor Swift",
		created_at: "",
		updated_at: "",
	},
	{
		id: "3",
		name: "Gorra Logo - Drake",
		slug: "gorra-logo-drake",
		description: "Gorra bordada con logo OVO",
		price: 2900,
		stock: 25,
		sizes: ["Única"],
		colors: ["Negro:#000000"],
		category_id: null,
		images: [
			"https://images.unsplash.com/photo-1588850561407-ed78c282e89b?w=400",
		],
		featured: true,
		artist: "Drake",
		created_at: "",
		updated_at: "",
	},
	{
		id: "4",
		name: "Hoodie Astroworld - Travis Scott",
		slug: "hoodie-astroworld-travis-scott",
		description: "Hoodie edición limitada Astroworld",
		price: 7500,
		stock: 3,
		sizes: ["M", "L", "XL"],
		colors: ["Negro:#000000", "Naranja:#F97316"],
		category_id: null,
		images: [
			"https://images.unsplash.com/photo-1578768079052-aa76e52ff62e?w=400",
		],
		featured: true,
		artist: "Travis Scott",
		created_at: "",
		updated_at: "",
	},
];

const products = featuredProducts?.length ? featuredProducts : mockProducts;

const mockCategories: Category[] = [
	{ id: "1", name: "Camisetas", slug: "camisetas", created_at: "" },
	{ id: "2", name: "Sudaderas", slug: "sudaderas", created_at: "" },
	{ id: "3", name: "Accesorios", slug: "accesorios", created_at: "" },
];

const cats = categories?.length ? categories : mockCategories;

// Create a map of category images for slideshow
const categoryProductsMap: Record<string, string[]> = {};
cats.forEach((cat) => {
	// Get products for this category
	const catProducts =
		allProducts?.filter((p) => p.category_id === cat.id) || [];
	// Extract images (first image of each product)
	const images = catProducts
		.map((p) => p.images?.[0])
		.filter((img): img is string => !!img)
		.slice(0, 5); // Max 5 images per category
	categoryProductsMap[cat.slug] = images;
});
---

<PublicLayout
	title="Inicio"
	description="FashionStore - Tu tienda de merch personalizado de tus artistas favoritos"
>
	<!-- Hero Section -->
	<section class="relative bg-navy-900 text-white overflow-hidden">
		<div class="absolute inset-0 opacity-20">
			<div
				class="absolute inset-0 bg-gradient-to-br from-accent-gold/30 to-transparent"
			>
			</div>
		</div>

		<div
			class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 lg:py-32"
		>
			<div class="max-w-2xl">
				<h1
					class="text-4xl lg:text-6xl font-serif font-bold leading-tight animate-slide-up"
				>
					Merch exclusivo de tus
					<span class="text-accent-gold">artistas favoritos</span>
				</h1>
				<p
					class="mt-6 text-lg text-navy-200 animate-slide-up"
					style="animation-delay: 0.1s;"
				>
					Colecciones oficiales, ediciones limitadas y productos
					únicos. Viste tu pasión por la música con estilo.
				</p>
				<div
					class="mt-8 flex flex-wrap gap-4 animate-slide-up"
					style="animation-delay: 0.2s;"
				>
					<Button href="/productos" variant="secondary" size="lg">
						Ver colección
					</Button>
					<Button
						href="#categorias"
						variant="outline"
						size="lg"
						class="border-white text-white hover:bg-white hover:text-navy-900"
					>
						Explorar
					</Button>
				</div>
			</div>
		</div>
	</section>

	<!-- Featured Products -->
	<section class="py-16 lg:py-24">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex items-end justify-between mb-10">
				<div>
					<h2
						class="text-3xl lg:text-4xl font-serif font-bold text-carbon-900"
					>
						Productos Destacados
					</h2>
					<p class="mt-2 text-carbon-500">
						Lo más buscado de esta temporada
					</p>
				</div>
				<a
					href="/productos"
					class="hidden sm:flex items-center gap-2 text-navy-800 font-medium hover:text-accent-gold transition-colors"
				>
					Ver todo
					<svg
						class="w-4 h-4"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M9 5l7 7-7 7"></path>
					</svg>
				</a>
			</div>

			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
				{products.map((product) => <ProductCard product={product} />)}
			</div>

			<div class="mt-10 text-center sm:hidden">
				<Button href="/productos" variant="outline"
					>Ver todos los productos</Button
				>
			</div>
		</div>
	</section>

	<!-- Categories -->
	<section id="categorias" class="py-16 lg:py-24 bg-white">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="text-center mb-12">
				<h2
					class="text-3xl lg:text-4xl font-serif font-bold text-carbon-900"
				>
					Compra por Categoría
				</h2>
				<p class="mt-2 text-carbon-500">
					Encuentra exactamente lo que buscas
				</p>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
				{
					cats.map((category) => {
						const images = categoryProductsMap[category.slug] || [];
						return (
							<a
								href={`/categoria/${category.slug}`}
								class="group relative h-64 rounded-xl overflow-hidden bg-navy-800"
								data-category-card
								data-images={JSON.stringify(images)}
							>
								{/* Slideshow container */}
								<div class="absolute inset-0 category-slideshow">
									{images.length > 0 ? (
										images.map((img, imgIndex) => (
											<img
												src={img}
												alt={category.name}
												class={`absolute inset-0 w-full h-full object-cover transition-opacity duration-700 ${imgIndex === 0 ? "opacity-100" : "opacity-0"}`}
												data-slide-index={imgIndex}
												loading="lazy"
											/>
										))
									) : (
										<div class="absolute inset-0 bg-navy-800" />
									)}
								</div>

								{/* Gradient overlay */}
								<div class="absolute inset-0 bg-gradient-to-t from-navy-900/90 via-navy-900/50 to-navy-900/20 z-10 group-hover:from-navy-900/95 transition-all duration-300" />

								{/* Content */}
								<div class="absolute bottom-0 left-0 right-0 p-6 z-20">
									<h3 class="text-2xl font-serif font-semibold text-white group-hover:text-accent-gold transition-colors">
										{category.name}
									</h3>
									<span class="inline-flex items-center gap-1 mt-2 text-sm text-white/80">
										Explorar
										<svg
											class="w-4 h-4 group-hover:translate-x-1 transition-transform"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M9 5l7 7-7 7"
											/>
										</svg>
									</span>
								</div>
							</a>
						);
					})
				}
			</div>
		</div>
	</section>
</PublicLayout>

<script>
	// Category slideshow animation
	document.addEventListener("DOMContentLoaded", () => {
		const categoryCards = document.querySelectorAll("[data-category-card]");

		categoryCards.forEach((card) => {
			const images = card.querySelectorAll("[data-slide-index]");
			if (images.length <= 1) return; // No slideshow needed

			let currentIndex = 0;

			setInterval(() => {
				// Hide current
				images[currentIndex].classList.remove("opacity-100");
				images[currentIndex].classList.add("opacity-0");

				// Show next
				currentIndex = (currentIndex + 1) % images.length;
				images[currentIndex].classList.remove("opacity-0");
				images[currentIndex].classList.add("opacity-100");
			}, 3000);
		});
	});
</script>
