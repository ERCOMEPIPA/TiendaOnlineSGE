---
export const prerender = false;

import AdminLayout from "../../../layouts/AdminLayout.astro";
import Button from "../../../components/ui/Button.astro";
import ImageUploader from "../../../components/islands/ImageUploader";
import { supabase } from "../../../lib/supabase";
import { slugify } from "../../../lib/utils";

// Handle form submission
let error = "";
let fieldErrors: Record<string, string> = {};

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();

    const name = formData.get("name") as string;
    const description = formData.get("description") as string;
    const price = parseInt(formData.get("price") as string) * 100; // Convert to cents
    const stock = parseInt(formData.get("stock") as string);
    const artist = formData.get("artist") as string;
    const sizes = (formData.get("sizes") as string)
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);
    const featured = formData.get("featured") === "on";
    const categoryId = (formData.get("category_id") as string) || null;
    const imageUrls = (formData.get("images") as string)
        .split("\n")
        .map((s) => s.trim())
        .filter(Boolean);

    // Validation
    if (!name) fieldErrors.name = "El nombre es obligatorio";
    if (isNaN(price) || price <= 0)
        fieldErrors.price = "El precio debe ser mayor a 0";
    if (isNaN(stock) || stock < 0)
        fieldErrors.stock = "El stock no puede ser negativo";

    if (Object.keys(fieldErrors).length === 0) {
        const slug = slugify(name);

        const { data, error: insertError } = await supabase
            .from("products")
            .insert({
                name,
                slug,
                description,
                price,
                stock,
                artist: artist || null,
                sizes,
                featured,
                category_id: categoryId,
                images: imageUrls,
            })
            .select()
            .single();

        if (insertError) {
            error =
                "Error al crear el producto. Por favor, inténtalo de nuevo.";
            console.error(insertError);
        } else {
            return Astro.redirect("/admin/productos?created=true");
        }
    }
}

// Fetch categories for select
const { data: categories } = await supabase
    .from("categories")
    .select("*")
    .order("name");

const mockCategories = [
    { id: "1", name: "Camisetas", slug: "camisetas" },
    { id: "2", name: "Sudaderas", slug: "sudaderas" },
    { id: "3", name: "Accesorios", slug: "accesorios" },
];

const allCategories = categories?.length ? categories : mockCategories;
---

<AdminLayout title="Nuevo Producto">
    <div class="max-w-3xl">
        {/* Breadcrumb */}
        <nav class="mb-6">
            <ol class="flex items-center gap-2 text-sm text-carbon-500">
                <li>
                    <a href="/admin/productos" class="hover:text-navy-800"
                        >Productos</a
                    >
                </li>
                <li>/</li>
                <li class="text-carbon-800 font-medium">Nuevo producto</li>
            </ol>
        </nav>

        {
            error && (
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                    {error}
                </div>
            )
        }

        <form method="POST" class="bg-white rounded-xl shadow-sm p-6">
            <div class="space-y-6">
                {/* Basic Info */}
                <div>
                    <h3 class="text-lg font-semibold text-carbon-900 mb-4">
                        Información básica
                    </h3>

                    <div class="grid gap-4">
                        <div>
                            <label
                                for="name"
                                class="block text-sm font-medium text-carbon-700 mb-2"
                            >
                                Nombre del producto *
                            </label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                required
                                class={`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500 
                  ${fieldErrors.name ? "border-red-300" : "border-carbon-200"}`}
                                placeholder="Ej: Camiseta Tour 2024 - Bad Bunny"
                            />
                            {
                                fieldErrors.name && (
                                    <p class="mt-1 text-sm text-red-600">
                                        {fieldErrors.name}
                                    </p>
                                )
                            }
                        </div>

                        <div>
                            <label
                                for="artist"
                                class="block text-sm font-medium text-carbon-700 mb-2"
                            >
                                Artista
                            </label>
                            <input
                                type="text"
                                id="artist"
                                name="artist"
                                class="w-full px-4 py-3 border border-carbon-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
                                placeholder="Ej: Bad Bunny"
                            />
                        </div>

                        <div>
                            <label
                                for="description"
                                class="block text-sm font-medium text-carbon-700 mb-2"
                            >
                                Descripción
                            </label>
                            <textarea
                                id="description"
                                name="description"
                                rows="4"
                                class="w-full px-4 py-3 border border-carbon-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
                                placeholder="Describe el producto..."
                            ></textarea>
                        </div>
                    </div>
                </div>

                {/* Pricing & Stock */}
                <div class="border-t border-carbon-100 pt-6">
                    <h3 class="text-lg font-semibold text-carbon-900 mb-4">
                        Precio e inventario
                    </h3>

                    <div class="grid sm:grid-cols-2 gap-4">
                        <div>
                            <label
                                for="price"
                                class="block text-sm font-medium text-carbon-700 mb-2"
                            >
                                Precio (€) *
                            </label>
                            <input
                                type="number"
                                id="price"
                                name="price"
                                step="0.01"
                                min="0"
                                required
                                class={`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500 
                  ${fieldErrors.price ? "border-red-300" : "border-carbon-200"}`}
                                placeholder="35.00"
                            />
                            {
                                fieldErrors.price && (
                                    <p class="mt-1 text-sm text-red-600">
                                        {fieldErrors.price}
                                    </p>
                                )
                            }
                        </div>

                        <div>
                            <label
                                for="stock"
                                class="block text-sm font-medium text-carbon-700 mb-2"
                            >
                                Stock *
                            </label>
                            <input
                                type="number"
                                id="stock"
                                name="stock"
                                min="0"
                                required
                                class={`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500 
                  ${fieldErrors.stock ? "border-red-300" : "border-carbon-200"}`}
                                placeholder="50"
                            />
                            {
                                fieldErrors.stock && (
                                    <p class="mt-1 text-sm text-red-600">
                                        {fieldErrors.stock}
                                    </p>
                                )
                            }
                        </div>
                    </div>
                </div>

                {/* Organization */}
                <div class="border-t border-carbon-100 pt-6">
                    <h3 class="text-lg font-semibold text-carbon-900 mb-4">
                        Organización
                    </h3>

                    <div class="grid sm:grid-cols-2 gap-4">
                        <div>
                            <label
                                for="category_id"
                                class="block text-sm font-medium text-carbon-700 mb-2"
                            >
                                Categoría
                            </label>
                            <select
                                id="category_id"
                                name="category_id"
                                class="w-full px-4 py-3 border border-carbon-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
                            >
                                <option value="">Sin categoría</option>
                                {
                                    allCategories.map((cat) => (
                                        <option value={cat.id}>
                                            {cat.name}
                                        </option>
                                    ))
                                }
                            </select>
                        </div>

                        <div>
                            <label
                                for="sizes"
                                class="block text-sm font-medium text-carbon-700 mb-2"
                            >
                                Tallas (separadas por coma)
                            </label>
                            <input
                                type="text"
                                id="sizes"
                                name="sizes"
                                class="w-full px-4 py-3 border border-carbon-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
                                placeholder="S, M, L, XL"
                            />
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input
                                type="checkbox"
                                name="featured"
                                class="w-5 h-5 rounded border-carbon-300 text-navy-800 focus:ring-navy-500"
                            />
                            <span class="text-sm text-carbon-700"
                                >Marcar como producto destacado</span
                            >
                        </label>
                    </div>
                </div>

                {/* Images */}
                <div class="border-t border-carbon-100 pt-6">
                    <h3 class="text-lg font-semibold text-carbon-900 mb-4">
                        Imágenes
                    </h3>

                    <div>
                        <label
                            class="block text-sm font-medium text-carbon-700 mb-2"
                        >
                            Arrastra o selecciona imágenes
                        </label>
                        <ImageUploader client:load inputName="images" />
                    </div>
                </div>

                {/* Actions */}
                <div
                    class="border-t border-carbon-100 pt-6 flex items-center justify-end gap-3"
                >
                    <Button href="/admin/productos" variant="ghost">
                        Cancelar
                    </Button>
                    <Button type="submit" variant="primary">
                        Crear producto
                    </Button>
                </div>
            </div>
        </form>
    </div>
</AdminLayout>
