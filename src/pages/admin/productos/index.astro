---
export const prerender = false;

import AdminLayout from "../../../layouts/AdminLayout.astro";
import Button from "../../../components/ui/Button.astro";
import ConfirmModal from "../../../components/ui/ConfirmModal.astro";
import { supabase, formatPrice } from "../../../lib/supabase";
import type { Product } from "../../../lib/supabase";

// Handle delete action
if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get("action");
    const productId = formData.get("productId") as string;

    if (action === "delete" && productId) {
        await supabase.from("products").delete().eq("id", productId);
        return Astro.redirect("/admin/productos?deleted=true");
    }
}

// Fetch all products
const { data: products } = await supabase
    .from("products")
    .select("*")
    .order("created_at", { ascending: false });

// Mock products for demo
const mockProducts: Product[] = [
    {
        id: "1",
        name: "Camiseta Tour 2024 - Bad Bunny",
        slug: "camiseta-tour-2024-bad-bunny",
        description: "Camiseta oficial",
        price: 3500,
        discount_price: null,
        discount_end_date: null,
        stock: 15,
        sizes: ["S", "M", "L", "XL"],
        colors: [],
        category_id: null,
        images: [
            "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=100",
        ],
        featured: true,
        artist: "Bad Bunny",
        created_at: "2024-01-15",
        updated_at: "",
    },
    {
        id: "2",
        name: "Sudadera Midnight - Taylor Swift",
        slug: "sudadera-midnight-taylor-swift",
        description: "Sudadera Midnights",
        price: 5900,
        discount_price: null,
        discount_end_date: null,
        stock: 8,
        sizes: ["S", "M", "L"],
        colors: [],
        category_id: null,
        images: [
            "https://images.unsplash.com/photo-1556821840-3a63f95609a7?w=100",
        ],
        featured: true,
        artist: "Taylor Swift",
        created_at: "2024-01-14",
        updated_at: "",
    },
    {
        id: "4",
        name: "Hoodie Astroworld - Travis Scott",
        slug: "hoodie-astroworld-travis-scott",
        description: "Hoodie edición limitada",
        price: 7500,
        discount_price: null,
        discount_end_date: null,
        stock: 3,
        sizes: ["M", "L", "XL"],
        colors: [],
        category_id: null,
        images: [
            "https://images.unsplash.com/photo-1578768079052-aa76e52ff62e?w=100",
        ],
        featured: true,
        artist: "Travis Scott",
        created_at: "2024-01-12",
        updated_at: "",
    },
];

const allProducts = products?.length ? products : mockProducts;

// Check for success messages
const deleted = Astro.url.searchParams.get("deleted");
const created = Astro.url.searchParams.get("created");
---

<AdminLayout title="Productos">
    {/* Success messages */}
    {
        deleted && (
            <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700">
                Producto eliminado correctamente.
            </div>
        )
    }

    {
        created && (
            <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700">
                Producto creado correctamente.
            </div>
        )
    }

    {/* Header */}
    <div class="flex items-center justify-between mb-6">
        <div>
            <p class="text-carbon-500">
                {allProducts.length} productos en el catálogo
            </p>
        </div>
        <Button href="/admin/productos/nuevo" variant="primary">
            <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"></path>
            </svg>
            Nuevo producto
        </Button>
    </div>

    {/* Products Table */}
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <table class="w-full">
            <thead class="bg-cream-50 border-b border-carbon-100">
                <tr>
                    <th
                        class="px-6 py-4 text-left text-sm font-semibold text-carbon-700"
                        >Producto</th
                    >
                    <th
                        class="px-6 py-4 text-left text-sm font-semibold text-carbon-700"
                        >Artista</th
                    >
                    <th
                        class="px-6 py-4 text-left text-sm font-semibold text-carbon-700"
                        >Precio</th
                    >
                    <th
                        class="px-6 py-4 text-left text-sm font-semibold text-carbon-700"
                        >Stock</th
                    >
                    <th
                        class="px-6 py-4 text-left text-sm font-semibold text-carbon-700"
                        >Estado</th
                    >
                    <th
                        class="px-6 py-4 text-right text-sm font-semibold text-carbon-700"
                        >Acciones</th
                    >
                </tr>
            </thead>
            <tbody class="divide-y divide-carbon-100">
                {
                    allProducts.map((product) => (
                        <tr class="hover:bg-cream-50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-carbon-100 rounded-lg overflow-hidden flex-shrink-0">
                                        {product.images?.[0] ? (
                                            <img
                                                src={product.images[0]}
                                                alt=""
                                                class="w-full h-full object-cover"
                                            />
                                        ) : (
                                            <div class="w-full h-full flex items-center justify-center text-carbon-400">
                                                <svg
                                                    class="w-6 h-6"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                                    />
                                                </svg>
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <p class="font-medium text-carbon-800">
                                            {product.name}
                                        </p>
                                        <p class="text-sm text-carbon-500">
                                            {product.sizes?.join(", ")}
                                        </p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-carbon-600">
                                {product.artist || "-"}
                            </td>
                            <td class="px-6 py-4">
                                {(() => {
                                    const now = new Date();
                                    const hasDiscount =
                                        product.discount_price &&
                                        product.discount_price * 100 <
                                            product.price &&
                                        (!product.discount_end_date ||
                                            new Date(
                                                product.discount_end_date,
                                            ) > now);

                                    if (hasDiscount) {
                                        return (
                                            <div>
                                                <span class="font-medium text-red-600">
                                                    {formatPrice(
                                                        product.discount_price *
                                                            100,
                                                    )}
                                                </span>
                                                <span class="text-sm text-carbon-400 line-through ml-2">
                                                    {formatPrice(product.price)}
                                                </span>
                                            </div>
                                        );
                                    }
                                    return (
                                        <span class="font-medium text-carbon-800">
                                            {formatPrice(product.price)}
                                        </span>
                                    );
                                })()}
                            </td>
                            <td class="px-6 py-4">
                                <span
                                    class={`font-medium ${product.stock <= 5 ? "text-red-600" : "text-carbon-800"}`}
                                >
                                    {product.stock}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col gap-1">
                                    {(() => {
                                        const now = new Date();
                                        const hasDiscount =
                                            product.discount_price &&
                                            product.discount_price * 100 <
                                                product.price &&
                                            (!product.discount_end_date ||
                                                new Date(
                                                    product.discount_end_date,
                                                ) > now);

                                        if (hasDiscount) {
                                            return (
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">
                                                    En oferta
                                                </span>
                                            );
                                        }
                                        return null;
                                    })()}
                                    {product.featured ? (
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent-gold/10 text-accent-gold">
                                            Destacado
                                        </span>
                                    ) : (
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-carbon-100 text-carbon-600">
                                            Normal
                                        </span>
                                    )}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center justify-end gap-2">
                                    <a
                                        href={`/admin/productos/${product.id}`}
                                        class="p-2 text-carbon-500 hover:text-navy-800 transition-colors"
                                        title="Editar"
                                    >
                                        <svg
                                            class="w-5 h-5"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                            />
                                        </svg>
                                    </a>
                                    <button
                                        type="button"
                                        class="delete-product-btn p-2 text-carbon-500 hover:text-red-600 transition-colors"
                                        data-product-id={product.id}
                                        data-product-name={product.name}
                                        title="Eliminar"
                                    >
                                        <svg
                                            class="w-5 h-5"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                            />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    ))
                }
            </tbody>
        </table>

        {
            allProducts.length === 0 && (
                <div class="text-center py-12">
                    <svg
                        class="w-12 h-12 mx-auto text-carbon-300 mb-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="1.5"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                        />
                    </svg>
                    <p class="text-carbon-500 mb-4">No hay productos todavía</p>
                    <Button href="/admin/productos/nuevo">
                        Crear primer producto
                    </Button>
                </div>
            )
        }
    </div>

    <ConfirmModal />

    <script>
        // Delete product functionality
        document.querySelectorAll(".delete-product-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                const target = e.currentTarget as HTMLButtonElement;
                const productId = target.dataset.productId;
                const productName = target.dataset.productName;

                const confirmed = await window.showConfirm(
                    `El producto "${productName}" se eliminará permanentemente y no podrá ser recuperado.`,
                    "¿Eliminar producto?"
                );
                
                if (confirmed) {
                    const form = document.createElement("form");
                    form.method = "POST";
                    form.innerHTML = `
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="productId" value="${productId}" />
                    `;
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
    </script>
</AdminLayout>
