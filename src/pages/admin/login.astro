---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabase";

// Check if already logged in
const accessToken = Astro.cookies.get("sb-access-token")?.value;
if (accessToken) {
    const {
        data: { user },
    } = await supabase.auth.getUser(accessToken);
    if (user) {
        return Astro.redirect("/admin");
    }
}

// Handle login form submission
let error = "";
if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const email = formData.get("email") as string;
    const password = formData.get("password") as string;

    const { data, error: authError } = await supabase.auth.signInWithPassword({
        email,
        password,
    });

    if (authError) {
        error = "Credenciales inválidas. Por favor, inténtalo de nuevo.";
    } else if (data.session) {
        // Set cookies
        Astro.cookies.set("sb-access-token", data.session.access_token, {
            path: "/",
            httpOnly: true,
            secure: import.meta.env.PROD,
            sameSite: "lax",
            maxAge: 60 * 60, // 1 hour
        });

        Astro.cookies.set("sb-refresh-token", data.session.refresh_token, {
            path: "/",
            httpOnly: true,
            secure: import.meta.env.PROD,
            sameSite: "lax",
            maxAge: 60 * 60 * 24 * 7, // 1 week
        });

        return Astro.redirect("/admin");
    }
}
---

<BaseLayout title="Admin Login">
    <div
        class="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-900 to-navy-950 px-4"
    >
        <div class="w-full max-w-md">
            <!-- Logo -->
            <div class="text-center mb-8">
                <a href="/" class="inline-block">
                    <span class="text-3xl font-serif font-bold text-white">
                        Fashion<span class="text-accent-gold">Store</span>
                    </span>
                </a>
                <p class="text-navy-300 mt-2">Panel de Administración</p>
            </div>

            <!-- Login Card -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h1 class="text-2xl font-semibold text-carbon-900 mb-6">
                    Iniciar sesión
                </h1>

                {
                    error && (
                        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                            {error}
                        </div>
                    )
                }

                <form method="POST" class="space-y-5">
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-carbon-700 mb-2"
                        >
                            Email
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            class="w-full px-4 py-3 border border-carbon-200 rounded-lg
                     focus:outline-none focus:ring-2 focus:ring-navy-500 focus:border-transparent
                     transition-colors"
                            placeholder="admin@fashionstore.com"
                        />
                    </div>

                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-carbon-700 mb-2"
                        >
                            Contraseña
                        </label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            required
                            class="w-full px-4 py-3 border border-carbon-200 rounded-lg
                     focus:outline-none focus:ring-2 focus:ring-navy-500 focus:border-transparent
                     transition-colors"
                            placeholder="••••••••"
                        />
                    </div>

                    <button
                        type="submit"
                        class="w-full py-3 px-6 bg-navy-800 text-white font-semibold rounded-lg
                   hover:bg-navy-900 transition-colors focus:outline-none focus:ring-2
                   focus:ring-navy-500 focus:ring-offset-2"
                    >
                        Iniciar sesión
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a
                        href="/"
                        class="text-sm text-carbon-500 hover:text-navy-800"
                    >
                        ← Volver a la tienda
                    </a>
                </div>
            </div>

            <p class="text-center text-navy-400 text-sm mt-6">
                &copy; {new Date().getFullYear()} FashionStore
            </p>
        </div>
    </div>
</BaseLayout>
