---
// Newsletter Popup Component - Shows on first visit
---

<div id="newsletter-popup" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div
        id="popup-backdrop"
        class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0"
    >
    </div>

    <!-- Modal -->
    <div class="flex items-center justify-center min-h-screen p-4">
        <div
            id="popup-modal"
            class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 transform transition-all duration-300 scale-95 opacity-0"
        >
            <!-- Close button -->
            <button
                id="close-popup"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>

            <!-- Content -->
            <div class="text-center">
                <!-- Icon/Emoji -->
                <div class="text-5xl mb-4">üéÅ</div>

                <!-- Title -->
                <h2 class="text-2xl font-serif font-bold text-gray-900 mb-2">
                    ¬°Obt√©n un 10% de descuento!
                </h2>

                <!-- Description -->
                <p class="text-gray-600 mb-6">
                    Suscr√≠bete a nuestra newsletter y recibe un <strong
                        class="text-navy-800">10% de descuento</strong
                    > en tu primera compra, adem√°s de ofertas exclusivas y novedades.
                </p>

                <!-- Form -->
                <form id="popup-newsletter-form" class="space-y-4">
                    <input
                        type="email"
                        id="popup-email"
                        name="email"
                        placeholder="Tu email..."
                        required
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-navy-500 focus:border-transparent transition-shadow"
                    />
                    <button
                        type="submit"
                        id="popup-submit-btn"
                        class="w-full px-6 py-3 bg-navy-800 text-white font-semibold rounded-xl hover:bg-navy-900 transition-colors flex items-center justify-center gap-2"
                    >
                        <span>¬°Quiero mi descuento!</span>
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </button>
                </form>

                <!-- Success message (hidden by default) -->
                <div id="popup-success" class="hidden">
                    <div class="text-5xl mb-4">üéâ</div>
                    <h3 class="text-xl font-bold text-green-700 mb-2">
                        ¬°Suscripci√≥n completada!
                    </h3>
                    <p class="text-gray-600 mb-4">
                        Revisa tu email para obtener tu c√≥digo de descuento.
                    </p>
                    <button
                        id="popup-continue"
                        class="px-6 py-3 bg-navy-800 text-white font-semibold rounded-xl hover:bg-navy-900 transition-colors"
                    >
                        Continuar comprando
                    </button>
                </div>

                <!-- No thanks link -->
                <button
                    id="popup-skip"
                    class="mt-4 text-sm text-gray-400 hover:text-gray-600 transition-colors"
                >
                    No, gracias
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    #newsletter-popup.show #popup-backdrop {
        opacity: 1;
    }

    #newsletter-popup.show #popup-modal {
        opacity: 1;
        transform: scale(1);
    }
</style>

<script>
    const POPUP_STORAGE_KEY = "newsletter_popup_shown";
    const POPUP_DELAY = 3000; // 3 seconds

    const popup = document.getElementById("newsletter-popup");
    const backdrop = document.getElementById("popup-backdrop");
    const closeBtn = document.getElementById("close-popup");
    const skipBtn = document.getElementById("popup-skip");
    const continueBtn = document.getElementById("popup-continue");
    const form = document.getElementById(
        "popup-newsletter-form",
    ) as HTMLFormElement;
    const emailInput = document.getElementById(
        "popup-email",
    ) as HTMLInputElement;
    const submitBtn = document.getElementById("popup-submit-btn");
    const successDiv = document.getElementById("popup-success");

    function showPopup() {
        if (!popup) return;
        popup.classList.remove("hidden");
        // Trigger animation after a frame
        requestAnimationFrame(() => {
            popup.classList.add("show");
        });
    }

    function hidePopup() {
        if (!popup) return;
        popup.classList.remove("show");
        setTimeout(() => {
            popup.classList.add("hidden");
        }, 300);
        // Mark as shown
        localStorage.setItem(POPUP_STORAGE_KEY, "true");
    }

    function shouldShowPopup(): boolean {
        // Don't show if already shown or subscribed
        return !localStorage.getItem(POPUP_STORAGE_KEY);
    }

    // Initialize
    if (shouldShowPopup()) {
        setTimeout(showPopup, POPUP_DELAY);
    }

    // Event listeners
    closeBtn?.addEventListener("click", hidePopup);
    skipBtn?.addEventListener("click", hidePopup);
    continueBtn?.addEventListener("click", hidePopup);
    backdrop?.addEventListener("click", hidePopup);

    // Form submit
    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = emailInput?.value;
        if (!email) return;

        const button = submitBtn as HTMLButtonElement;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `
            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Procesando...</span>
        `;

        try {
            const response = await fetch("/api/newsletter", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, source: "popup" }),
            });

            const data = await response.json();

            if (data.success) {
                // Show success
                form.classList.add("hidden");
                skipBtn?.classList.add("hidden");
                successDiv?.classList.remove("hidden");
                // Mark as subscribed
                localStorage.setItem(POPUP_STORAGE_KEY, "subscribed");
            } else {
                alert(data.error || "Error al procesar la suscripci√≥n");
                button.disabled = false;
                button.innerHTML = originalText;
            }
        } catch (error) {
            alert("Error de conexi√≥n. Int√©ntalo de nuevo.");
            button.disabled = false;
            button.innerHTML = originalText;
        }
    });
</script>
